
Функция ПолучитьНовыйКлюч ( Ключи, Количество = 1 ) Экспорт 
	
	УстановитьПривилегированныйРежим ( Истина );
	максимум = определитьМаксимальныйКод ( Ключи ); 
	м = Новый Массив ();
	данные = ПолучитьКлючиСтрок ();
	Для счетчик = 1 По Количество Цикл
		ключСтроки = данные [ максимум ];
		Если ( ключСтроки = Неопределено ) Тогда
			ключОбъект = Справочники.КлючиСтрок.СоздатьЭлемент ();
			ключОбъект.Код = максимум;
			Попытка
				ключОбъект.Записать ();
			Исключение
				Сообщить ( "Не удалось создать ключ строки. Обратитесь к администратору!", СтатусСообщения.Важное );   
				УстановитьПривилегированныйРежим ( Ложь );
				Возврат Ложь;
			КонецПопытки;
			ключСтроки = ключОбъект.Ссылка;
		КонецЕсли;
		м.Добавить ( ключСтроки );
		максимум = максимум + 1;		
	КонецЦикла; 
	УстановитьПривилегированныйРежим ( Ложь );
	Если ( Количество = 1 ) Тогда
		Возврат м [ 0 ];
	Иначе
		Возврат м;
	КонецЕсли;

КонецФункции

Функция определитьМаксимальныйКод ( Ключи )
	
	Если ( Ключи.Количество () = 0 ) Тогда
		максимум = 1;
	Иначе
		с = "
		|выбрать
		|	максимум ( Код ) как Код
		|из
		|	Справочник.КлючиСтрок
		|где
		|	Ссылка в ( &Ключи )  
		|";
		запрос = Новый Запрос ( с );
		запрос.УстановитьПараметр ( "Ключи", Ключи );
		результат = запрос.Выполнить ();
		выборка = результат.Выбрать ();
		выборка.Следующий ();
		максимум = выборка.Код + 1;
	КонецЕсли;
	Возврат максимум;

КонецФункции

Функция ПолучитьКлючиСтрок ( Количество = 0 ) Экспорт 
	
	запрос = Новый Запрос ();
	с = "
	|выбрать
	|	Ссылка как Ссылка,
	|	Код как Код
	|из
	|	Справочник.КлючиСтрок
	|";
	Если ( Количество <> 0 ) Тогда
		с = с + " где Код <= &Количество ";
		запрос.УстановитьПараметр ( "Количество", Количество );
	КонецЕсли;
	с = с + " 
	|упорядочить по
	|	Код возр 
	|";
	запрос.Текст = с;
	результат = запрос.Выполнить ();
	выборка = результат.Выбрать ();
	с = Новый Соответствие ();
	Пока ( выборка.Следующий () ) Цикл
		с.Вставить ( выборка.Код, выборка.Ссылка );	
	КонецЦикла; 
	Возврат с;

КонецФункции

Функция СоздатьКлючСтроки ( Код ) Экспорт 
	
	УстановитьПривилегированныйРежим ( Истина );
	ключ = Справочники.КлючиСтрок.СоздатьЭлемент ();
	ключ.Код = Код;
	Попытка
		ключ.Записать ();
	Исключение
		Сообщить ( "Не удалось создать ключ строки. Обратитесь к администратору!", СтатусСообщения.Важное );   
		ключ = Справочники.КлючиСтрок.ПустаяСсылка ();
	КонецПопытки;
	УстановитьПривилегированныйРежим ( Ложь );
	Возврат ключ;

КонецФункции 